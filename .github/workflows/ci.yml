# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" , "release**"]
  pull_request:
    branches: [ "main", "release**" ]
    
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

env:
  AUTHENTICATION_URL: 'https://api-auth.qa.switchee.co/oauth2/token'
  POST_FIRMWARE_URL: 'https://api.qa.switchee.co/v2.0/properties'
  
  #AUTHENTICATION_URL: 'https://company.free.beeceptor.com'
  #POST_FIRMWARE_URL: 'https://company.free.beeceptor.com'
  
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "update cloud"
  update-cloud:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      #Push a HTTP request for new firmware binaries (artifact) generated
      - name: Token request to QA API
        id: tokenRequest
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ env.AUTHENTICATION_URL}}
          method: 'POST'
          customHeaders: '{"Content-Type": "application/x-www-form-urlencoded", "Authorization": "Basic ${{ secrets.AUTHORIZATION_DATA }}"}'
          data: '{"grant_type" : "client_credentials", "scope" : "https://api.qa.switchee.co/api.client"}'
      - name: Response from request
        run: |
          echo ${{ fromJson(steps.tokenRequest.outputs.response).access_token }}
          echo "ACCESS_TOKEN=${{ fromJson(steps.tokenRequest.outputs.response).access_token }}" >> $GITHUB_ENV
      - name: Post firmware name to QA API
        id: updateFirmwareRequest
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ env.POST_FIRMWARE_URL}}
          method: 'GET'
          customHeaders: '{"Content-Type": "application/json", "Authorization": "Bearer ${{ env.ACCESS_TOKEN }}", "x-api-key":"G0zz1oWEgBjHI1jw4qhp33ffuxcM1vF7ugDpSHu4"}'
          
          #method: 'POST' 
          #customHeaders: '{"Content-Type": "application/json", "Authorization": "Bearer ${{ env.ACCESS_TOKEN }}", "x-api-key":"G0zz1oWEgBjHI1jw4qhp33ffuxcM1vF7ugDpSHu4"}'
          #data: '{"type":"Gen 2 Hub", "gh-artefact" : "${{ env.GH_FW_VERSION_FULL }}", "repo_name": "${{GITHUB_REPOSITORY}}",  "display": "", "file":""}'
          #customHeaders: '{"Content-Type": "application/json"}'
          #method: 'POST' 
          #customHeaders: '{"Content-Type": "application/json", "Authorization": "Bearer ${{ env.ACCESS_TOKEN }}", "x-api-key":"G0zz1oWEgBjHI1jw4qhp33ffuxcM1vF7ugDpSHu4"}'
          #data: '{"type":"Gen 2 Hub", "gh-artefact" : "${{ env.GH_FW_VERSION_FULL }}", "repo_name": "${{GITHUB_REPOSITORY}}",  "display": "", "file":""}'
          #customHeaders: '{"Content-Type": "application/json"}'
      - name: Response from request
        run: |
          echo ${{ steps.updateFirmwareRequest.outputs }}     
          echo ${{ fromJson(steps.updateFirmwareRequest.outputs.response) }}        
